<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BP Analyzer (PC ver.)</title>

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; color: #333; }
  h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
  .controls { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
  input, select, button { padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
  button { background: #3498db; color: white; border: none; cursor: pointer; transition: 0.2s; }
  button:hover { background: #2980b9; }

  .specimen-box { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-left: 5px solid #3498db; }
  .file-result { border-top: 1px solid #eee; padding: 12px 0; margin-top: 10px; }
  .file-name { font-weight: bold; color: #e67e22; margin-bottom: 5px; display: block; }
  
  table { border-collapse: collapse; width: 100%; margin-top: 8px; background: #fafafa; }
  th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; text-align: center; }
  th { background: #f1f3f5; color: #555; }

  .log { background: #2d3436; color: #dfe6e9; padding: 10px; margin-top: 8px; font-size: 11px; display: none; white-space: pre-wrap; border-radius: 4px; font-family: monospace; }
  .btn-log { background: #95a5a6; font-size: 11px; margin-top: 5px; }
</style>
</head>

<body>

<h1>ğŸ©º BP Analyzer (PC ver.)</h1>

<div class="controls">
  <strong>Mode: </strong>
  <select id="mode">
    <option value="control">Control (Diff 20-60)</option>
    <option value="induction">Induction (Diff 25-80)</option>
  </select>
  <input type="file" id="fileInput" multiple accept=".csv">
  <button onclick="processFiles()">Analyze & Group by Rat ID</button>
</div>

<div id="result"></div>

<script>
/**
 * í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: Specimen ì´ë¦„ì—ì„œ Rat IDë§Œ ì •ë°€í•˜ê²Œ ì¶”ì¶œ
 */
function extractSpecimenKey(specimen) {
  if (!specimen) return "Unknown";
  
  // 1. ê´„í˜¸ () ì•ˆì˜ ë‚´ìš©ì„ ì°¾ìŒ
  const match = specimen.match(/\(([^)]+)\)/);
  if (match && match[1]) {
    return match[1].trim(); // ê´„í˜¸ ì•ˆì˜ IDë§Œ ë°˜í™˜ (ê³µë°± ì œê±°)
  }
  
  // 2. ê´„í˜¸ê°€ ì—†ëŠ” ê²½ìš°, ë§ˆì§€ë§‰ ê³µë°±ì´ë‚˜ í•˜ì´í”ˆ ë’¤ì˜ ë‹¨ì–´ë¥¼ IDë¡œ ì¶”ì •
  const parts = specimen.split(/[\s\-_]+/);
  return parts[parts.length - 1].trim();
}

function processFiles() {
  const fileInput = document.getElementById("fileInput");
  const files = fileInput.files;
  if (files.length === 0) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

  const mode = document.getElementById("mode").value;
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "<p>Processing...</p>";

  const globalGrouped = {}; // ì „ì²´ íŒŒì¼ì„ í†µí•©í•˜ì—¬ ì €ì¥í•  ê°ì²´
  let filesProcessed = 0;

  for (const file of files) {
    const reader = new FileReader();
    reader.onload = e => {
      parseCSV(e.target.result, file.name, mode, globalGrouped);
      filesProcessed++;
      if (filesProcessed === files.length) render(globalGrouped);
    };
    reader.readAsText(file);
  }
}

function parseCSV(text, filename, mode, globalGrouped) {
  const rows = text.split(/\r?\n/).filter(line => line.trim() !== "").map(r => r.split(","));
  if (rows.length < 2) return;

  const header = rows[0];
  const idx = {
    specimen: header.indexOf("Specimen"),
    sbp: header.indexOf("Systolic"),
    dbp: header.indexOf("Diastolic"),
    mean: header.indexOf("Mean"),
    volume: header.indexOf("Volume"),
    accepted: header.indexOf("Accepted"),
    regular: header.indexOf("Regular Cycle"),
    time: header.indexOf("Time")
  };

  const data = rows.slice(1).filter(r => r.length > idx.sbp);

  // ì´ íŒŒì¼ ë‚´ì—ì„œ ê°œì²´ë³„ë¡œ ì„ì‹œ ë¶„ë¥˜
  const tempBySpecimen = {};

  data.forEach(r => {
    if (r[idx.accepted] !== "True" || r[idx.regular] !== "True") return;

    const sbp = Number(r[idx.sbp]);
    const dbp = Number(r[idx.dbp]);
    const diff = sbp - dbp;

    // ëª¨ë“œë³„ í•„í„°ë§
    if (mode === "control" && (diff < 20 || diff > 60)) return;
    if (mode === "induction" && (diff < 25 || diff > 80)) return;

    const rawName = r[idx.specimen];
    const key = extractSpecimenKey(rawName); // ì—¬ê¸°ì„œ ë‚ ì§œ ë–¼ê³  Rat IDë§Œ ê°€ì ¸ì˜´

    if (!tempBySpecimen[key]) tempBySpecimen[key] = [];
    tempBySpecimen[key].push(r);
  });

  // ì„ì‹œ ë¶„ë¥˜ëœ ë°ì´í„°ë¥¼ globalGroupedì— í†µí•©
  for (const key in tempBySpecimen) {
    const cycles = tempBySpecimen[key];
    if (cycles.length < 3) continue; // ë°ì´í„°ê°€ ë„ˆë¬´ ì ìœ¼ë©´ ì œì™¸ (ì„ íƒ ì‚¬í•­)

    const sbps = cycles.map(r => Number(r[idx.sbp]));
    const maxSBP = Math.max(...sbps);
    const minSBP = Math.min(...sbps);

    // Max/Min ì œì™¸í•œ í•„í„°ë§
    const filtered = cycles.filter(r => {
      const v = Number(r[idx.sbp]);
      return v !== maxSBP && v !== minSBP;
    });

    if (filtered.length === 0) continue;

    const avg = arr => Math.floor(arr.reduce((a,b)=>a+b,0)/arr.length);
    
    if (!globalGrouped[key]) globalGrouped[key] = [];

    globalGrouped[key].push({
      file: filename,
      time: filtered[0][idx.time] || "N/A",
      sbp: avg(filtered.map(r => Number(r[idx.sbp]))),
      dbp: avg(filtered.map(r => Number(r[idx.dbp]))),
      mean: avg(filtered.map(r => Number(r[idx.mean]))),
      volume: avg(filtered.map(r => Number(r[idx.volume]))),
      count: filtered.length,
      log: filtered.map((r, i) => `Cycle ${i+1}: SBP=${r[idx.sbp]}, DBP=${r[idx.dbp]}`).join("\n")
    });
  }
}

function render(grouped) {
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";
  
  const keys = Object.keys(grouped).sort();

  if (keys.length === 0) {
    resultDiv.innerHTML = "<p>ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„° ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”.</p>";
    return;
  }

  keys.forEach(key => {
    const box = document.createElement("div");
    box.className = "specimen-box";
    box.innerHTML = `<h3>ğŸ€ Rat ID: ${key}</h3>`;

    // í•´ë‹¹ IDì˜ ëª¨ë“  íŒŒì¼ ê²°ê³¼ ì¶œë ¥
    grouped[key].forEach((r, idx) => {
      const div = document.createElement("div");
      div.className = "file-result";
      const logId = `log-${key.replace(/\s+/g, '')}-${idx}`;

      div.innerHTML = `
        <span class="file-name">ğŸ“‚ ${r.file}</span>
        <small>Cycles used (excl. Max/Min): ${r.count}</small>
        <table>
          <tr><th>Time</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th></tr>
          <tr>
            <td>${r.time}</td>
            <td>${r.sbp}</td>
            <td>${r.dbp}</td>
            <td>${r.mean}</td>
            <td>${r.volume}</td>
          </tr>
        </table>
        <button class="btn-log" onclick="toggleLog('${logId}')">View Cycle Details</button>
        <div id="${logId}" class="log">${r.log}</div>
      `;
      box.appendChild(div);
    });

    resultDiv.appendChild(box);
  });
}

function toggleLog(id) {
  const el = document.getElementById(id);
  el.style.display = (el.style.display === "block") ? "none" : "block";
}
</script>

</body>
</html>
