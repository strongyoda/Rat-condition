<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BP Analyzer (PC ver.)</title>

<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background-color: #f4f7f9; 
  color: #333; 
  padding: 30px; 
  line-height: 1.6;
}

h1 { 
  color: #2c3e50; 
  border-bottom: 3px solid #3498db; 
  padding-bottom: 10px; 
  margin-bottom: 30px; 
  font-size: 24px;
}

.controls { 
  background: white; 
  padding: 20px; 
  border-radius: 10px; 
  box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
  margin-bottom: 30px; 
}

.controls label {
  font-weight: bold;
  margin-right: 15px;
  cursor: pointer;
}

input[type="file"] {
  margin-top: 15px;
  padding: 10px;
  border: 2px dashed #cbd5e0;
  width: 100%;
  box-sizing: border-box;
  border-radius: 8px;
}

.rat-box {
  background: white;
  border: none;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border-left: 6px solid #3498db;
}

.rat-title {
  font-size: 18px;
  color: #3498db;
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: white;
}

th {
  background: #f8f9fa;
  color: #718096;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

th, td {
  border: 1px solid #edf2f7;
  padding: 12px 8px;
  text-align: center;
}

tr:hover { background-color: #fdfdfd; }

.toggle-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 5px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.toggle-btn:hover { background: #2980b9; }

.log-table {
  margin: 10px 0;
  font-size: 13px;
  background: #f9fafb !important;
  border: 1px solid #e2e8f0;
}

.log-table th { background: #edf2f7; color: #4a5568; }

/* ÌÖçÏä§Ìä∏ Í∞ïÏ°∞ */
td b { color: #2c3e50; }
td:first-child { color: #e67e22; font-weight: 500; } /* ÌååÏùºÎ™Ö Í∞ïÏ°∞ */
</style>
</head>

<body>

<h1>BP Analyzer (PC ver.)</h1>

<div class="controls">
  <label>
    <input type="radio" name="mode" value="control" checked> Control
  </label>
  <label style="margin-left:20px;">
    <input type="radio" name="mode" value="induction"> Induction
  </label>
  <br><br>
  <input type="file" id="fileInput" accept=".csv" multiple>
</div>

<div id="output"></div>

<script>
let allData = [];

document.getElementById("fileInput").addEventListener("change", loadFiles);

function loadFiles(e) {
  allData = [];
  const files = Array.from(e.target.files);
  const mode = document.querySelector('input[name="mode"]:checked').value;
  let loaded = 0;

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      parseCSV(reader.result, file.name);
      loaded++;
      if (loaded === files.length) analyze(mode);
    };
    reader.readAsText(file);
  });
}

function parseCSV(text, filename) {
  const rows = text.trim().split("\n").map(r => r.split(","));
  const header = rows.shift();
  const idx = n => header.indexOf(n);

  rows.forEach(r => {
    if (r.length < 5) return; // Îπà Ï§Ñ Î∞©ÏßÄ
    allData.push({
      file: filename,
      time: r[idx("Time")],
      specimen: r[idx("Specimen Name")],
      regular: r[idx("Regular Cycle")] === "True",
      accepted: r[idx("Accepted")] === "True",
      sbp: Number(r[idx("Systolic")]),
      dbp: Number(r[idx("Diastolic")]),
      mean: Number(r[idx("Mean")]),
      volume: Number(r[12]) // MÏó¥ Volume
    });
  });
}

function analyze(mode) {
  const output = document.getElementById("output");
  output.innerHTML = "";

  /* [ÌïµÏã¨ ÏàòÏ†ï] specimenÏóêÏÑú IDÎßå Ï∂îÏ∂úÌïòÏó¨ Í∑∏Î£πÌôî */
  const grouped = {};
  allData.forEach(r => {
    // Í¥ÑÌò∏ () ÏïàÏùò Î¨∏ÏûêÏó¥Îßå Ï∂îÏ∂ú (Ïòà: "2023-Rat(01)" -> "01")
    const match = r.specimen.match(/\(([^)]+)\)/);
    const ratId = match ? match[1].trim() : r.specimen.trim();

    if (!grouped[ratId]) grouped[ratId] = {};
    if (!grouped[ratId][r.file]) grouped[ratId][r.file] = [];
    grouped[ratId][r.file].push(r);
  });

  Object.keys(grouped).sort().forEach(ratId => {
    const box = document.createElement("div");
    box.className = "rat-box";
    box.innerHTML = `<div class="rat-title">üêÄ Í∞úÏ≤¥ ID: ${ratId}</div>`;

    const table = document.createElement("table");
    table.innerHTML = `
      <tr>
        <th>File</th>
        <th>n</th>
        <th>SBP</th>
        <th>DBP</th>
        <th>Mean</th>
        <th>Volume</th>
        <th>Í≤ÄÏ¶ù</th>
      </tr>
    `;

    Object.entries(grouped[ratId]).forEach(([file, rows], idx) => {
      const valid = rows.filter(r => r.regular && r.accepted);
      if (valid.length === 0) return;

      const sbps = valid.map(r => r.sbp);
      const maxSBP = Math.max(...sbps);
      const minSBP = Math.min(...sbps);

      const judged = rows.map(r => {
        let reason = "‚úÖ Accepted";
        if (!r.regular || !r.accepted) {
          reason = "‚ùå Regular/Accepted";
        } else if (r.sbp === maxSBP) {
          reason = "‚ùå SBP = MAX (set)";
        } else if (r.sbp === minSBP) {
          reason = "‚ùå SBP = MIN (set)";
        } else {
          const diff = r.sbp - r.dbp;
          if (mode === "control" && (diff < 20 || diff > 60)) reason = "‚ùå Pulse diff";
          if (mode === "induction" && (diff < 25 || diff > 80)) reason = "‚ùå Pulse diff";
        }
        return { ...r, reason };
      });

      const passed = judged.filter(r => r.reason === "‚úÖ Accepted");
      if (passed.length === 0) return;

      const avgFloor = key => Math.floor(passed.reduce((s, r) => s + r[key], 0) / passed.length);
      const logId = `log_${ratId.replace(/[^a-z0-9]/gi, '_')}_${idx}`;

      table.innerHTML += `
        <tr>
          <td>${file}</td>
          <td>${passed.length}</td>
          <td>${avgFloor("sbp")}</td>
          <td>${avgFloor("dbp")}</td>
          <td>${avgFloor("mean")}</td>
          <td>${avgFloor("volume")}</td>
          <td>
            <button class="toggle-btn" onclick="toggleLog('${logId}')">ÏÇ¨Ïù¥ÌÅ¥ Î°úÍ∑∏</button>
          </td>
        </tr>
        <tr id="${logId}" style="display:none;">
          <td colspan="7">
            <table class="log-table">
              <tr>
                <th>Time</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th><th>ÌåêÏ†ï</th>
              </tr>
              ${judged.map(r => `
                <tr>
                  <td>${r.time}</td>
                  <td>${r.sbp}</td>
                  <td>${r.dbp}</td>
                  <td>${r.mean}</td>
                  <td>${r.volume}</td>
                  <td>${r.reason}</td>
                </tr>
              `).join("")}
            </table>
          </td>
        </tr>
      `;
    });

    box.appendChild(table);
    output.appendChild(box);
  });
}

function toggleLog(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "none" ? "table-row" : "none";
}
</script>

</body>
</html>
