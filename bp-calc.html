<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BP Analyzer (PC ver.)</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 20px;
}

h1 {
  margin-bottom: 10px;
}

input, select {
  margin: 10px 0;
}

.specimen-box {
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.file-result {
  border-top: 1px solid #ddd;
  padding-top: 10px;
  margin-top: 10px;
}

table {
  border-collapse: collapse;
  margin-top: 8px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 10px;
  font-size: 13px;
  text-align: center;
}

button {
  margin-top: 8px;
  padding: 6px 12px;
  cursor: pointer;
}

.log {
  background: #f1f3f5;
  padding: 10px;
  margin-top: 8px;
  font-size: 12px;
  display: none;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<h1>ü©∫ BP Analyzer (PC ver.)</h1>

<select id="mode">
  <option value="control">Control</option>
  <option value="induction">Induction</option>
</select>

<br>
<input type="file" id="fileInput" multiple accept=".csv">
<button onclick="processFiles()">Analyze</button>

<hr>

<div id="result"></div>

<script>
function extractSpecimenKey(specimen) {
  // Ïòà: "20251223 Cohort 11 (C1110G1)" -> "C1110"
  const match = specimen.match(/\((C\d+)\w*\)/i);
  return match ? match[1].trim() : specimen.trim();
}

function processFiles() {
  const files = document.getElementById("fileInput").files;
  const mode = document.getElementById("mode").value;
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  const grouped = {};

  let pending = files.length;

  for (const file of files) {
    const reader = new FileReader();
    reader.onload = e => {
      parseCSV(e.target.result, file.name, mode, grouped);
      pending--;
      if (pending === 0) render(grouped);
    };
    reader.readAsText(file);
  }
}

function parseCSV(text, filename, mode, grouped) {
  const rows = text.split(/\r?\n/).map(r => r.split(","));
  const header = rows[0];

  const idx = {
    specimen: header.indexOf("Specimen"),
    sbp: header.indexOf("Systolic"),
    dbp: header.indexOf("Diastolic"),
    mean: header.indexOf("Mean"),
    volume: header.indexOf("Volume"),
    accepted: header.indexOf("Accepted"),
    regular: header.indexOf("Regular Cycle"),
    time: header.indexOf("Time")
  };

  const data = rows.slice(1).filter(r => r.length > idx.sbp);

  const bySpecimen = {};

  data.forEach(r => {
    if (r[idx.accepted] !== "True" || r[idx.regular] !== "True") return;

    const diff = Number(r[idx.sbp]) - Number(r[idx.dbp]);
    if (mode === "control" && (diff < 20 || diff > 60)) return;
    if (mode === "induction" && (diff < 25 || diff > 80)) return;

    const key = extractSpecimenKey(r[idx.specimen]);
    if (!bySpecimen[key]) bySpecimen[key] = [];
    bySpecimen[key].push(r);
  });

  for (const key in bySpecimen) {
    const cycles = bySpecimen[key];

    const sbps = cycles.map(r => Number(r[idx.sbp]));
    const maxSBP = Math.max(...sbps);
    const minSBP = Math.min(...sbps);

    const filtered = cycles.filter(r => {
      const sbp = Number(r[idx.sbp]);
      return sbp !== maxSBP && sbp !== minSBP;
    });

    if (!grouped[key]) grouped[key] = [];

    const avg = arr => Math.floor(arr.reduce((a,b)=>a+b,0)/arr.length);

    const sbpAvg = avg(filtered.map(r => Number(r[idx.sbp])));
    const dbpAvg = avg(filtered.map(r => Number(r[idx.dbp])));
    const meanAvg = avg(filtered.map(r => Number(r[idx.mean])));
    const volAvg = avg(filtered.map(r => Number(r[idx.volume])));

    const log = filtered.map((r,i)=>(
      `Cycle ${i+1}: SBP=${r[idx.sbp]}, DBP=${r[idx.dbp]}, PASS`
    )).join("\n");

    grouped[key].push({
      file: filename,
      time: filtered[0]?.[idx.time] || "",
      sbp: sbpAvg,
      dbp: dbpAvg,
      mean: meanAvg,
      volume: volAvg,
      count: filtered.length,
      log
    });
  }
}

function render(grouped) {
  const resultDiv = document.getElementById("result");
  const keys = Object.keys(grouped).sort();

  keys.forEach(key => {
    const box = document.createElement("div");
    box.className = "specimen-box";
    box.innerHTML = `<h3>üêÄ ${key}</h3>`;

    grouped[key].forEach((r, idx) => {
      const div = document.createElement("div");
      div.className = "file-result";

      const logId = `${key}-${idx}`;

      div.innerHTML = `
        <b>${r.file}</b><br>
        Cycles used: ${r.count}
        <table>
          <tr><th>Time</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th></tr>
          <tr>
            <td>${r.time}</td>
            <td>${r.sbp}</td>
            <td>${r.dbp}</td>
            <td>${r.mean}</td>
            <td>${r.volume}</td>
          </tr>
        </table>
        <button onclick="toggleLog('${logId}')">ÏÇ¨Ïù¥ÌÅ¥ Î°úÍ∑∏</button>
        <div id="${logId}" class="log">${r.log}</div>
      `;
      box.appendChild(div);
    });

    resultDiv.appendChild(box);
  });
}

function toggleLog(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "none" ? "block" : "none";
}
</script>

</body>
</html>

