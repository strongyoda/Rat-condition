<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Rat íˆ¬ì•½ ê³„ì‚°ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 15px;
      background: #f7f7f7;
    }
    h2 {
      text-align: center;
      margin-bottom: 5px;
    }
    .sub {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #eee;
    }
    input {
      width: 90%;
      padding: 4px;
      font-size: 14px;
    }
    button {
      margin-top: 15px;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background: #2c7be5;
      color: white;
      border: none;
      border-radius: 6px;
    }
    .result {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      display: none;
    }
    .result ul {
      padding-left: 18px;
    }
    .saved {
      margin-top: 15px;
      padding: 12px;
      background: #e6f4ea;
      color: #137333;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
  </style>
</head>

<body>

<h2>ğŸ€ Rat íˆ¬ì•½ ê³„ì‚°ê¸°</h2>
<div class="sub">
  Telmisartan Â· 4 mg/kg/day Â· 2.5 mg/ml<br>
  ì¤€ë¹„ëŸ‰ 15% ì¦ëŸ‰ í¬í•¨
</div>

<label><b>Cohort ë²ˆí˜¸</b></label><br>
<input type="number" id="cohort"><br><br>

<table>
  <thead>
    <tr>
      <th>ê°œì²´ ë²ˆí˜¸</th>
      <th>ëª¸ë¬´ê²Œ (g)</th>
      <th>Rat ID</th>
    </tr>
  </thead>
  <tbody id="ratTable"></tbody>
</table>

<button onclick="confirmAndRun()">ê³„ì‚° í›„ ì €ì¥</button>

<div class="result" id="result"></div>
<div class="saved" id="savedMsg">âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<!-- Google Form -->
<form id="googleForm" method="POST" target="hidden_iframe"
  action="https://docs.google.com/forms/d/e/1FAIpQLSe8Prms_YgWmZv3UQCcSlNFi_dbdQwQiMPFhDJ2RVhBvRkCmw/formResponse">
  <div id="formFields"></div>
</form>
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
const DOSE = 4;      // mg/kg
const CONC = 2.5;   // mg/ml
const LOSS = 1.15;  // 15% ì¦ëŸ‰

// ì…ë ¥ í–‰ 12ê°œ ìƒì„±
const tbody = document.getElementById("ratTable");
for (let i = 1; i <= 12; i++) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="number" id="num_${i}"></td>
    <td><input type="number" id="wt_${i}"></td>
    <td id="id_${i}" style="font-size:12px;color:#555;">-</td>
  `;
  tbody.appendChild(tr);
}

function confirmAndRun() {
  if (!confirm("ê³„ì‚° í›„ ì €ì¥í• ê¹Œìš”?")) return;
  calculateAndSubmit();
}

function calculateAndSubmit() {
  const cohort = document.getElementById("cohort").value;
  if (!cohort) {
    alert("Cohort ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  let totalMg = 0;
  let resultHTML = "<h3>ğŸ“Š ì˜¤ëŠ˜ ì†Œë¶„ ìš©ëŸ‰</h3><ul>";
  let formHTML = "";

  for (let i = 1; i <= 12; i++) {
    const num = document.getElementById(`num_${i}`).value;
    const wt = document.getElementById(`wt_${i}`).value;
    if (!num || !wt) continue;

    const ratId = `C${cohort}${String(num).padStart(2, "0")}`;
    document.getElementById(`id_${i}`).innerText = ratId;

    const doseMg = (wt / 1000) * DOSE;
    const volume = doseMg / CONC;

    totalMg += doseMg;

    // ê²°ê³¼: ì†Œë¶„ mlë§Œ í‘œì‹œ
    resultHTML += `<li>${ratId} â†’ <b>${volume.toFixed(2)} ml</b></li>`;

    // Google Form ë°ì´í„°
    formHTML += `
      <input name="entry.1181462162" value="${cohort}">
      <input name="entry.1898368339" value="${num}">
      <input name="entry.914775563" value="${ratId}">
      <input name="entry.1852662343" value="${wt}">
      <input name="entry.2132680140" value="${doseMg.toFixed(3)}">
      <input name="entry.532722932" value="${volume.toFixed(3)}">
    `;
  }

  const adjMg = totalMg * LOSS;
  const adjMl = adjMg / CONC;

  resultHTML += `
    </ul>
    <hr>
    <b>ğŸ§ª ì˜¤ëŠ˜ ì¤€ë¹„ëŸ‰</b><br>
    ì•½ë¬¼: ${adjMg.toFixed(2)} mg<br>
    ìš©ì•¡ ì´ëŸ‰: ${adjMl.toFixed(2)} ml
  `;

  document.getElementById("result").innerHTML = resultHTML;
  document.getElementById("result").style.display = "block";

  document.getElementById("formFields").innerHTML = formHTML;
  document.getElementById("googleForm").submit();

  // ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€
  const msg = document.getElementById("savedMsg");
  msg.style.display = "block";
}
</script>

</body>
</html>