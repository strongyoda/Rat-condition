<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Dose Calculator</title>
</head>
<body>

<h2>투약 계산기</h2>

<p>
  코호트 번호<br>
  <input id="cohort">
</p>

<p>
  개체 번호<br>
  <input id="animalNo">
</p>

<p>
  Rat ID<br>
  <input id="ratId">
</p>

<p>
  Body weight (g)<br>
  <input id="weight">
</p>

<button onclick="addAnimal()">개체 추가</button>

<hr>

<h3>개체별 소분 용량</h3>

<table border="1" cellpadding="5">
  <thead>
    <tr>
      <th>Rat ID</th>
      <th>Body weight (g)</th>
      <th>소분 용량 (ml)</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<p id="totalVolume"></p>

<button onclick="saveData()">계산 후 저장</button>

<!-- ✅ 여기만 추가됨 -->
<hr>
<button onclick="location.href='index.html'">홈으로</button>

<script>
const DOSE = 4;        // mg/kg/day
const CONC = 2.5;      // mg/ml
const LOSS = 1.15;     // 15% 증량

const animals = [];

function addAnimal() {
  const cohort = document.getElementById("cohort").value;
  const animalNo = document.getElementById("animalNo").value;
  const ratId = document.getElementById("ratId").value;
  const weight = parseFloat(document.getElementById("weight").value);

  if (!cohort || !animalNo || !ratId || !weight) {
    alert("모든 값을 입력하세요.");
    return;
  }

  const baseMg = (weight / 1000) * DOSE;
  const adjMg = baseMg * LOSS;
  const volume = adjMg / CONC;

  animals.push({
    cohort,
    animalNo,
    ratId,
    weight,
    doseMg: adjMg,
    volume
  });

  render();
  document.getElementById("weight").value = "";
  document.getElementById("ratId").value = "";
}

function render() {
  const tbody = document.getElementById("resultBody");
  tbody.innerHTML = "";

  let total = 0;

  animals.forEach(a => {
    total += a.volume;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${a.ratId}</td>
      <td>${a.weight}</td>
      <td>${a.volume.toFixed(3)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalVolume").innerText =
    "오늘 준비량: " + total.toFixed(3) + " ml";
}

function saveData() {
  if (animals.length === 0) {
    alert("저장할 데이터가 없습니다.");
    return;
  }

  if (!confirm("계산 결과를 저장할까요?")) return;

  animals.forEach(a => {
    const url =
      "https://docs.google.com/forms/d/e/1FAIpQLSe8Prms_YgWmZv3UQCcSlNFi_dbdQwQiMPFhDJ2RVhBvRkCmw/formResponse";

    const data = new URLSearchParams();
    data.append("entry.1181462162", a.cohort);
    data.append("entry.1898368339", a.animalNo);
    data.append("entry.914775563", a.ratId);
    data.append("entry.1852662343", a.weight);
    data.append("entry.2132680140", a.doseMg.toFixed(4));
    data.append("entry.532722932", a.volume.toFixed(4));

    fetch(url, {
      method: "POST",
      mode: "no-cors",
      body: data
    });
  });

  alert("저장되었습니다.");
}
</script>

</body>
</html>
