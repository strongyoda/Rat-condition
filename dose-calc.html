<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Dose Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #f2f2f2;
    }
    button {
      margin-top: 15px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .home-btn {
      margin-top: 30px;
      background: #eee;
    }
  </style>
</head>
<body>

<h2>투약 계산기</h2>

<label>코호트 번호</label><br>
<input id="cohort" type="number"><br><br>

<label>개체 번호</label><br>
<input id="animalNo" type="number"><br><br>

<label>Rat ID</label><br>
<input id="ratId" type="number"><br><br>

<label>Body weight (g)</label><br>
<input id="weight" type="number"><br><br>

<button onclick="addAnimal()">개체 추가</button>

<hr>

<h3>개체별 소분 용량</h3>
<table id="resultTable">
  <thead>
    <tr>
      <th>Rat ID</th>
      <th>Body weight (g)</th>
      <th>소분 용량 (ml)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3 id="totalVolume" style="margin-top:20px;"></h3>

<button onclick="saveData()">계산 후 저장</button>

<br>
<button class="home-btn" onclick="location.href='index.html'">홈으로</button>

<script>
const DOSE = 4;        // mg/kg
const CONC = 2.5;      // mg/ml
const LOSS = 1.15;     // 15% 증량

const animals = [];

function addAnimal() {
  const cohort = document.getElementById("cohort").value;
  const animalNo = document.getElementById("animalNo").value;
  const ratId = document.getElementById("ratId").value;
  const weight = parseFloat(document.getElementById("weight").value);

  if (!cohort || !animalNo || !ratId || !weight) {
    alert("모든 값을 입력하세요.");
    return;
  }

  const baseMg = (weight / 1000) * DOSE;
  const adjMg = baseMg * LOSS;
  const volume = adjMg / CONC;

  animals.push({
    cohort,
    animalNo,
    ratId,
    weight,
    doseMg: adjMg,
    volume
  });

  renderTable();
  clearWeightOnly();
}

function renderTable() {
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  let totalMl = 0;

  animals.forEach(a => {
    totalMl += a.volume;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.ratId}</td>
      <td>${a.weight}</td>
      <td>${a.volume.toFixed(3)}</td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById("totalVolume").innerText =
    `오늘 준비량: ${totalMl.toFixed(3)} ml`;
}

function clearWeightOnly() {
  document.getElementById("weight").value = "";
  document.getElementById("ratId").value = "";
}

function saveData() {
  if (animals.length === 0) {
    alert("저장할 데이터가 없습니다.");
    return;
  }

  if (!confirm("계산 결과를 저장할까요?")) return;

  animals.forEach(a => {
    const formUrl =
      "https://docs.google.com/forms/d/e/1FAIpQLSe8Prms_YgWmZv3UQCcSlNFi_dbdQwQiMPFhDJ2RVhBvRkCmw/formResponse";

    const data = new URLSearchParams();
    data.append("entry.1181462162", a.cohort);
    data.append("entry.1898368339", a.animalNo);
    data.append("entry.914775563", a.ratId);
    data.append("entry.1852662343", a.weight);
    data.append("entry.2132680140", a.doseMg.toFixed(4));
    data.append("entry.532722932", a.volume.toFixed(4));

    fetch(formUrl, {
      method: "POST",
      mode: "no-cors",
      body: data
    });
  });

  alert("저장되었습니다.");
}
</script>

</body>
</html>
